<script>
/* === ARENA ¬∑ Phase 5E+ ‚Äî Dynamic CallList ‚Üí Job/Company/Candidate Resolver === */
window.addEventListener('load', function(){
  if(!window.Arena){ console.warn('‚ö†Ô∏è Arena base not found'); return; }

  (function(A){

    A.loadCallListReal = function(callListId){
      console.log('üß© 5E+: Resolving CallList', callListId);

      google.script.run.withSuccessHandler(function(list){
        if(!list){ console.error('‚ùå No CallList for', callListId); return; }

        // --- Normalize IDs --------------------------------------------------
        var jobId = String(list.JobID || '').trim();
        if(/^J\d{3}$/.test(jobId)) jobId = 'JOB0' + jobId.replace(/\D/g,''); // turn J001‚ÜíJOB0001
        var candStr = String(list.CandidateIDs || '').trim();

        // --- Update Arena state --------------------------------------------
        A.state.callList = list;
        A.state.callListID = list.CallListID;
        A.state.jobID = jobId;
        A.state.candidateIDs = candStr
          .replace(/[, ]+/g,';')
          .split(';')
          .filter(Boolean);

        console.log('üìã CallList:', list);
        console.log('üß† jobID:', jobId, ' | candidates:', A.state.candidateIDs.length);

        // --- 1Ô∏è‚É£ Load Job + Company ----------------------------------------
        google.script.run.withSuccessHandler(function(bundle){
          if(!bundle || !bundle.job){
            console.warn('‚ö†Ô∏è No job found for', jobId);
            return;
          }
          console.log('üè¢ Bundle:', bundle);
          A.state.job = bundle.job;
          A.state.company = bundle.company || null;
          A.renderJob(A.state.job);          // refresh left column
          if(A.state.company) A.renderCompanyPanel && A.renderCompanyPanel(A.state.company);
        }).getJobCompanyBundle(jobId);

        // --- 2Ô∏è‚É£ Load Candidates -------------------------------------------
        if(A.state.candidateIDs.length){
          google.script.run.withSuccessHandler(function(cands){
            console.log('üë• Candidates fetched:', cands.length);
            A.state.candidates = cands;
            if(cands.length){
              A.state.index = 0;
              A.state.candidate = cands[0];
              A.renderCandidate(cands[0]);
              A.renderActions(cands[0], A.state.recruiter);
              A._updateCounter();
            }
          }).getCandidatesByIds(A.state.candidateIDs);
        }

      }).getCallListById(callListId);
    };

    console.log('‚úÖ Arena ¬∑ Phase 5E+ dynamic resolver loaded');
  })(window.Arena);
});
</script>
