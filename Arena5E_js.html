<script>
/* === ARENA ¬∑ Phase 5E+ ‚Äî Dynamic CallList ‚Üí Job/Company/Candidate Resolver (fixed) === */
window.addEventListener('load', function(){
  if (!window.Arena) { console.warn('‚ö†Ô∏è Arena base not found'); return; }

  (function (A) {

    A.loadCallListReal = function (callListId) {
      console.log('üß© 5E+: Resolving CallList', callListId);

      google.script.run.withSuccessHandler(function (list) {
        if (!list) { console.error('‚ùå No CallList for', callListId); return; }

        // Make sure we always have a display name
        if (!list.Name && list.CallListName) list.Name = list.CallListName;

        // --- Normalize JobID to JOB + 4 digits ----------------------------
        var jobId = String(list.JobID || '').trim();
        var digits = jobId.replace(/\D/g, '');
        if (/^J\d+$/i.test(jobId)) {                // J001 ‚Üí JOB0001
          jobId = 'JOB' + ('0000' + digits).slice(-4);
        } else if (/^JOB\d{3}$/i.test(jobId)) {     // JOB001 ‚Üí JOB0001
          jobId = 'JOB' + ('0000' + digits).slice(-4);
        }

        // --- Normalize CandidateIDs (commas / spaces / newlines) ----------
        var candStr = String(list.CandidateIDs || '')
          .replace(/^"+|"+$/g, '')
          .replace(/[\r\n]+/g, ';')
          .replace(/[ ,]+/g, ';')
          .replace(/;+$/,'')
          .trim();

        // --- Update Arena state -------------------------------------------
        A.state.callList = list;
        A.state.callListID = list.CallListID;
        A.state.jobID = jobId;
        A.state.candidateIDs = candStr ? candStr.split(';') : [];

        console.log('üìã CallList:', list);
        console.log('üß† jobID:', jobId, '| candidates:', A.state.candidateIDs.length);

        // 1) Load Job + Company
        google.script.run.withSuccessHandler(function (bundle) {
          if (!bundle || !bundle.job) {
            console.warn('‚ö†Ô∏è No job found for', jobId);
            return;
          }
          console.log('üè¢ Bundle:', bundle);
          A.state.job = bundle.job;
          A.state.company = bundle.company || null;

          // Left column
          if (A.renderJob) A.renderJob(A.state.job);
          if (A.renderCompanyPanel && A.state.company) A.renderCompanyPanel(A.state.company);

        }).getJobCompanyBundle(jobId);

        // 2) Load Candidates (full profiles for right/middle UI)
        if (A.state.candidateIDs.length) {
          google.script.run.withSuccessHandler(function (cands) {
            console.log('üë• Candidates fetched:', cands.length);
            A.state.candidates = cands || [];
            if (cands && cands.length) {
              A.state.index = 0;
              A.state.candidate = cands[0];
              if (A.renderCandidate) A.renderCandidate(cands[0]);
              if (A.renderActions) A.renderActions(cands[0], A.state.recruiter);
              if (A._updateCounter) A._updateCounter();
            } else {
              // Clear middle/right when empty
              var mid = document.getElementById('arena-middle');
              if (mid) mid.innerHTML = '<div class="arena-card"><h3>Candidate Profile</h3><p>No candidates in this list.</p></div>';
              var right = document.getElementById('arena-right');
              if (right) right.innerHTML = '<div class="arena-card"><h3>Quick Actions</h3><p>Select a candidate to begin.</p></div>';
            }
          }).getCandidatesByIds(A.state.candidateIDs);
        } else {
          console.warn('‚ö†Ô∏è No candidate IDs on this CallList.');
        }
      }).getCallListById(callListId);
    };

    console.log('‚úÖ Arena ¬∑ Phase 5E+ dynamic resolver loaded (fixed)');
  })(window.Arena);
});
</script>

