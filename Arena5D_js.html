<script>
/* === ARENA ¬∑ Phase 5D+ ‚Äî Real Call Lists + Diagnostic Hooks (ES5-safe) === */
window.addEventListener('load', function(){
  if(!window.Arena){
    console.error('‚ùå Arena base not found; cannot attach CallLists menu.');
    return;
  }

  (function(A){
    console.log('üß© Phase 5D+: initializing real CallLists menu‚Ä¶');

    /* ---------- Locate dropdown ---------- */
    var sel = document.getElementById('arena-calllist');
    if(!sel){
      console.warn('‚ö†Ô∏è No <select id="arena-calllist"> element found. Create one in your header.');
      return;
    }

    /* ---------- Clear + placeholder ---------- */
    sel.innerHTML = '<option>Loading Call Lists‚Ä¶</option>';

    /* ---------- Backend call ---------- */
    google.script.run
      .withSuccessHandler(function(lists){
        try {
          console.log('‚úÖ CallLists received:', lists);
          if(!lists || !lists.length){
            sel.innerHTML = '<option>No Call Lists Found</option>';
            return;
          }

          var html = '<option value="">‚Äî Select Call List ‚Äî</option>';
          for(var i=0;i<lists.length;i++){
            var l = lists[i];
            html += '<option value="'+l.CallListID+'">'+(l.Name || l.CallListID)+' ('+(l.Status || '‚Äî')+')</option>';
          }
          sel.innerHTML = html;

          console.log('üìã Dropdown populated with', lists.length, 'items.');
        } catch(err){
          console.error('üí• Error building dropdown:', err);
          sel.innerHTML = '<option>Error loading lists</option>';
        }
      })
      .withFailureHandler(function(e){
        console.error('‚ùå getAllCallLists failed:', e);
        sel.innerHTML = '<option>Error retrieving lists</option>';
      })
      .getAllCallLists();

    /* ---------- Selection handler ---------- */
    sel.onchange = function(){
      var id = sel.value;
      if(!id){
        console.log('‚ÑπÔ∏è No CallList selected');
        return;
      }
      console.log('üîó Selected CallList:', id);
      A.state.callListID = id;

      /* Load candidates + job + company */
      if(typeof A.loadCallListReal === 'function'){
        console.log('üöÄ Launching A.loadCallListReal for', id);
        A.loadCallListReal(id);
      } else {
        console.warn('‚ö†Ô∏è A.loadCallListReal not yet defined. Using fallback stub.');
        // --- fallback mock ---
        google.script.run.withSuccessHandler(function(rows){
          console.log('Mock candidate data loaded for', id, rows);
        }).getCandidatesByCallList && google.script.run.getCandidatesByCallList(id);
      }
    };

    console.log('‚úÖ Arena ¬∑ Phase 5D+ fully initialized');
  })(window.Arena);
});
</script>
